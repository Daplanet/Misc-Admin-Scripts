#!/bin/bash
# UKFast Plesk exploit finder/fixer. 

if [[ $UID != 0 ]]; then
    echo "You need to run this script as root."
    exit 1
fi

if [[ ! -e /etc/psa ]]; then
    echo "This server doesn't appear to have Plesk installed."
    exit 1
fi

if [[ ! -x /usr/bin/unzip ]]; then
    echo "Please install the unzip program."
    echo "Debian/Ubuntu: apt-get install unzip"
    echo "CentOS/RHEL: yum install unzip"
    exit 1
fi

echo
echo "THIS SCRIPT COMES WITH NO WARRANTY, EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK."
echo
echo "This script will find all 'km0ae9gr6m' compromised files under /var/www/vhosts"
echo "and clean them up. Backups of the affected scripts will be taken and stored in"
echo "/root/compfiles. This may take a while..."
echo
echo "Press ENTER to start, CTRL+C to quit."
echo
read

if [[ ! -d /root/compfiles ]]; then
    mkdir /root/compfiles 
fi

echo "Starting search, please be patient."
echo

for file in $(find /var/www/vhosts -type f \( -iname "*.js" -o -iname "*.php" \) -exec egrep -sHl '(km0ae9gr6m|gootkit)' {} \;); do
    echo -n "Compromised filed found: ${file}... "
    /usr/bin/rsync -qaR $file /root/compfiles/
    /usr/bin/perl -i -0777pe's|(.*)/\*km0ae9gr6m\*/.*|$1\n|s' $file
    echo "cleaned."
done

echo
echo "All compromised files should now be clean."
echo 
echo "All Plesk passwords, apart from database and email passwords, MUST be changed."
echo "If you do not change the passwords, you will likely be compromised again."
echo "New passwords will be echoed to the screen and saved in ./newpasswords.txt"
echo -n "Would you like to change these passwords automatically now? [Y/n]: "
read -n1 pwchange

if [[ $pwchange == "N" || $pwchange == "n" ]]; then
    echo
    echo "Not changing passwords. You MUST do this yourself to prevent further compromises."
    exit 0;
fi

NEWADMINPW="$(openssl rand -base64 8)"

/usr/bin/wget -q -O /tmp/ppc.zip "http://kb.parallels.com/Attachments/19094/Attachments/plesk_password_changer.zip"
unzip -q -d /tmp /tmp/ppc.zip
php -d open_basedir=  -d safe_mode=0 /tmp/plesk_password_changer.php `cat /etc/psa/.psa.shadow` ${NEWADMINPW} --admin --resellers --clients --domains --domainadmins --users --additionalftpaccounts --subdomains --webusers | tee newpasswords.txt

echo
echo "Done. Please save a copy of the passwords above or see newpasswords.txt in this directory."
echo
exit 0
